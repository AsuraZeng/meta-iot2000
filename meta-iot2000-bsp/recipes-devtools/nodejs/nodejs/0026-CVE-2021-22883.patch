From f52bf6ddc3ea75e0fa7ec1497ad506d6647fcb84 Mon Sep 17 00:00:00 2001
From: chao zeng <chao.zeng@siemens.com>
Date: Fri, 15 Jul 2022 11:00:43 +0800
Subject: [PATCH 26/32] CVE-2021-22883
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Ported from
OpenSuse:nodejs8-8.17.0-150200.10.22.1:CVE-2021-22883

Original commit message:

    Only backport unit test. Node8 does not trigger.

    From 922ada77132c1b0b69c9a146822d762b2f9b912b Mon Sep 17 00:00:00 2001
    From: Daniel Bevenius <daniel.bevenius@gmail.com>
    Date: Fri, 22 Jan 2021 12:34:21 +0100
    Subject: [PATCH] http2: add unknownProtocol timeout
    MIME-Version: 1.0
    Content-Type: text/plain; charset=UTF-8
    Content-Transfer-Encoding: 8bit

    This commit add a configuration options named unknownProtocolTimeout
    which can be specified to set a value for the timeout in milliseconds
    that a server should wait when an unknowProtocol is sent to it. When
    this happens a timer will be started and the if the socket has not been
    destroyed during that time the timer callback will destoy it.

    Refs: https://hackerone.com/reports/1043360
    CVE-ID: CVE-2021-22883
    PR-URL: https://github.com/nodejs-private/node-private/pull/246
    Backport-PR-URL: https://github.com/nodejs-private/node-private/pull/250
    Reviewed-By: Beth Griggs <bgriggs@redhat.com>
    Reviewed-By: Matteo Collina <matteo.collina@gmail.com>
    Reviewed-By: Michael Dawson <midawson@redhat.com>
    Reviewed-By: Rich Trott <rtrott@gmail.com>
    Reviewed-By: Tobias Nie√üen <tniessen@tnie.de>

Signed-off-by: chao zeng <chao.zeng@siemens.com>
---
 .../test-http2-server-unknown-protocol.js     | 39 +++++++++++++++++++
 1 file changed, 39 insertions(+)
 create mode 100644 test/parallel/test-http2-server-unknown-protocol.js

diff --git a/test/parallel/test-http2-server-unknown-protocol.js b/test/parallel/test-http2-server-unknown-protocol.js
new file mode 100644
index 0000000000..3ecddcc91e
--- /dev/null
+++ b/test/parallel/test-http2-server-unknown-protocol.js
@@ -0,0 +1,39 @@
+'use strict';
+const common = require('../common');
+const fixtures = require('../common/fixtures');
+
+// This test verifies that when a server receives an unknownProtocol it will
+// not leave the socket open if the client does not close it.
+
+if (!common.hasCrypto)
+  common.skip('missing crypto');
+
+const h2 = require('http2');
+const tls = require('tls');
+
+const certPem = fixtures.readSync('test_cert.pem', 'ascii');
+const keyPem = fixtures.readSync('test_key.pem', 'ascii');
+
+//  key: fixtures.readKey('rsa_private_2048.pem'),
+//  cert: fixtures.readKey('rsa_public_2048.pem'),
+
+const server = h2.createSecureServer({
+  cert: certPem,
+  key: keyPem,
+  unknownProtocolTimeout: 500,
+  allowHalfOpen: true
+});
+
+server.on('connection', (socket) => {
+  socket.on('close', common.mustCall(() => {
+    server.close();
+  }));
+});
+
+server.listen(0, function() {
+  tls.connect({
+    port: server.address().port,
+    rejectUnauthorized: false,
+    ALPNProtocols: ['bogus']
+  });
+});
-- 
2.34.1

