From 6fbfa68123d3a6af92a6b9db9f231a3d20a7eca5 Mon Sep 17 00:00:00 2001
From: chao zeng <chao.zeng@siemens.com>
Date: Fri, 15 Jul 2022 10:38:34 +0800
Subject: [PATCH 28/32] CVE-2021-22939

Ported from
OpenSuse:nodejs8-8.17.0-150200.10.22.1:CVE-2021-22939

Original commit message:

    From 1780bbc3291357f7c3370892eb311fc7a62afe8d Mon Sep 17 00:00:00 2001
    From: Matteo Collina <hello@matteocollina.com>
    Date: Wed, 4 Aug 2021 18:40:00 +0200
    Subject: [PATCH] tls: validate "rejectUnauthorized: undefined"

    Incomplete validation of rejectUnauthorized parameter (Low)

    If the Node.js https API was used incorrectly and "undefined" was passed
    in for the "rejectUnauthorized" parameter, no error was returned and
    connections to servers with an expired certificate would have been
    accepted.

    CVE-ID: CVE-2021-22939
    Refs: https://nvd.nist.gov/vuln/detail/CVE-2021-22939
    Refs: https://hackerone.com/reports/1278254
    PR-URL: https://github.com/nodejs-private/node-private/pull/276
    Reviewed-By: Rich Trott <rtrott@gmail.com>
    Reviewed-By: Akshay K <iit.akshay@gmail.com>
    Reviewed-By: Robert Nagy <ronagy@icloud.com>
    Reviewed-By: Richard Lau <rlau@redhat.com>

Signed-off-by: chao zeng <chao.zeng@siemens.com>
---
 test/parallel/test-tls-client-reject.js | 13 +++++++++++++
 1 file changed, 13 insertions(+)

diff --git a/test/parallel/test-tls-client-reject.js b/test/parallel/test-tls-client-reject.js
index 955d97da6f..8fdde38073 100644
--- a/test/parallel/test-tls-client-reject.js
+++ b/test/parallel/test-tls-client-reject.js
@@ -67,6 +67,19 @@ function rejectUnauthorized() {
   socket.write('ng');
 }
 
+function rejectUnauthorizedUndefined() {
+  console.log('reject unauthorized undefined');
+  const socket = tls.connect(server.address().port, {
+    servername: 'localhost',
+    rejectUnauthorized: undefined
+  }, common.mustNotCall());
+  socket.on('data', common.mustNotCall());
+  socket.on('error', common.mustCall(function(err) {
+    authorized();
+  }));
+  socket.end('ng');
+}
+
 function authorized() {
   const socket = tls.connect(server.address().port, {
     ca: [fixtures.readSync('test_cert.pem')],
-- 
2.34.1

